"""added a comparison_correlation_id based on template.id and prompt.id

Revision ID: fd623475cd7c
Revises: 4d220a984a72
Create Date: 2024-11-25 18:47:13.333294

"""

from typing import Sequence, Union

import sqlalchemy as sa
from alembic import op

# revision identifiers, used by Alembic.
revision: str = "fd623475cd7c"
down_revision: Union[str, None] = "4d220a984a72"
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.execute("""\
        CREATE OR REPLACE FUNCTION generate_correlation_id(first_bigint bigint, second_bigint bigint)
        RETURNS uuid AS $$
        DECLARE
            hex_string text;
        BEGIN
            hex_string := encode(
                sha256(
                    (first_bigint::text || ',' || second_bigint::text)::bytea
                ),
                'hex'
            );
            RETURN (
                substring(hex_string from 1 for 8) || '-' ||
                substring(hex_string from 9 for 4) || '-' ||
                substring(hex_string from 13 for 4) || '-' ||
                substring(hex_string from 17 for 4) || '-' ||
                substring(hex_string from 21 for 12)
            )::uuid;
        END;
        $$ LANGUAGE plpgsql IMMUTABLE; 
    """)

    op.add_column(
        "sample",
        sa.Column("comparison_correlation_id", sa.UUID(), nullable=True),
        schema="sample",
    )

    op.execute("""\
    UPDATE sample.sample
    SET comparison_correlation_id = generate_correlation_id(template.id, prompt.id)
    FROM specification.run, specification.template, specification.prompt
    WHERE 
        sample.sample.run_id = specification.run.id
        and run.prompt_id = prompt.id
        and run.template_id = template.id
    """)

    # ### end Alembic commands ###


def downgrade() -> None:
    raise RuntimeError("Upgrades only")
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_column("sample", "comparison_correlation_id", schema="sample")
    # ### end Alembic commands ###
